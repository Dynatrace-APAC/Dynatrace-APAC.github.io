
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Dynatrace with Istio</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="../../elements/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid="UA-175467274-1"
                  id="istio"
                  title="Dynatrace with Istio"
                  environment="web"
                  feedback-link="mailto:APAC-SE-Central@dynatrace.com">
    
      <google-codelab-step label="Introduction" duration="1">
        <p>This repository contains labs for the Istio Hands-On Session. We will be using Google Kubernetes Engine (GKE) for this hands-on but for China participants, please attempt to use Microk8s on AWS. You can use <a href="https://github.com/keptn-sandbox/keptn-in-a-box" target="_blank">Keptn in a box</a> to easily spin up a Istio based K8s instance</p>
<h2 is-upgraded>Prerequisites</h2>
<ul>
<li>Google Cloud account with access to GKE. Use <strong>ANY</strong> of the following:  <ul>
<li>Corporate account via #team-gotc on Slack (eg. brandon.neo@dynatrace.com on <strong>ACM Workshops APAC</strong> project)</li>
<li>Free trial access <a href="https://cloud.google.com/free/" target="_blank">here</a>.</li>
</ul>
</li>
<li>Chrome Browser with <a href="https://chrome.google.com/webstore/detail/modify-header-value-http/cbdibdfhahmknbkkojljfncpnhmacdek" target="_blank">browser extension</a></li>
<li>Enable Envoy Tracing in your Dynatrace Environment  <ul>
<li><strong>Settings &gt; Monitored Technologies &gt; Envoy</strong></li>
</ul>
</li>
</ul>
<h2 class="checklist" is-upgraded>What You&#39;ll Learn</h2>
<ul class="checklist">
<li>How to leverage Istio in Dynatrace</li>
<li>Learn Kiali and its difference with Dynatrace</li>
<li>Setting up GKE on Istio</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Setting up your Google Kubernetes Environment (GKE)" duration="10">
        <h2 is-upgraded>Login to Google Cloud Platform Account</h2>
<p>Either login to your corporate account or signup with Google Cloud Platform free <a href="https://cloud.google.com/free/" target="_blank">here</a></p>
<p>You can login to your GCP console <a href="https://console.cloud.google.com/home/" target="_blank">here</a>.</p>
<p class="image-container"><img alt="GCP-Homepage" src="img/1f9711d41bd92133.png"></p>
<h2 is-upgraded>Enable Kubernetes Engine API</h2>
<p>You will also need to <strong>Enable your API Billing</strong> with Kubernetes Engine API.</p>
<p class="image-container"><img alt="k8s-Engine" src="img/70bde55b634a381a.png"></p>
<p>You should be prompted to the billing page while setting up your GKE instance.</p>
<p>If not, you can follow the steps <a href="https://support.google.com/googleapi/answer/6158867?hl=en" target="_blank">here</a></p>
<h2 is-upgraded>Activate Cloud Shell</h2>
<p class="image-container"><img alt="GKE-Menu" src="img/64aaa2f325ae3dd3.png"></p>
<p>Click on the Terminal Icon on the top right</p>
<p>A Cloud based Terminal lookalike will appear at the bottom of the page</p>
<p>We will start setting up our GKE Cluster</p>
<h2 is-upgraded>Download the Istio Hands-on Repo</h2>
<p>Run the following command to download from our Github Repo</p>
<p><code>https://github.com/dynatrace-acm/istio-handson</code></p>
<p>The above will create a folder call <strong>istio-handson</strong>. This will contain the scripts we will use for the remainder of the workshop</p>
<p class="image-container"><img alt="GKE-Cloud-shell" src="img/5d0ee7f7a5874a75.png"></p>
<h2 is-upgraded>Dynatrace Tokens</h2>
<p>In order to proceed further we need to make note of our Dynatrace Tenant/Environment and API/PaaS Tokens</p>
<p>For the Tenant ID, you can find it in the first part of your URL https://.managed-dev.dynalabs.io For example, for https://abc123.managed-dev.dynalabs.io, Tenant ID=abc123</p>
<p>The Environment ID - You can find this value in the second half of your URL https://.managed-dev.dynalabs.io/e/ For example, for https://abc1234.managed-dev.dynalabs.io/e/1234-5678, Environment ID=1234-5678</p>
<p>Go in <strong>Settings -&gt; Integration -&gt; Dynatrace API</strong></p>
<ul>
<li>Click on Generate Token</li>
<li>Enter a name for your token (e.g. GKE)</li>
<li>Don&#39;t forget to click on the Save button</li>
</ul>
<p class="image-container"><img alt="Token" src="img/dab5eb69fda20f5d.png"></p>
<p>Go in <strong>Settings -&gt; Integration -&gt; Platform as a Service</strong></p>
<ul>
<li>Either copy the existing InstallerDownload token or click on Generate Token</li>
<li>Enter a name for your token (e.g. GKE), click Save</li>
</ul>
<p class="image-container"><img alt="Token" src="img/3b0ad24ec3f4fe3b.png"></p>
<h2 is-upgraded>Creating Credentials</h2>
<p>We now need to store a local copy of our Dynatrace Tenant and API info for use when creating our cluster</p>
<p>Navigate to the directory <strong>1-Credentials</strong> and execute the script <code>defineCredentials.sh</code> This will ask for your Dynatrace Tenant/Environment information as well as your API and PaaS tokens These values can be obtained from your Dynatrace tenant (see previous instructions) Once you have entered the values and confirmed they are correct, we can move on to creating our cluster</p>
<p class="image-container"><img alt="Crendentials" src="img/640c3b60a77c7dd3.png"></p>
<p>Positive :This step will take about 10 minutes to complete</p>
<h2 is-upgraded>Setup GKE Cluster</h2>
<p>Back in your GCP account, launch a <strong>Cloudshell session</strong> Navigate to the directory <strong>2-CreateCluster</strong> Execute the script <strong>setupenv.sh</strong> and confirm that your credentials are correct</p>
<p class="image-container"><img alt="CreateCluster" src="img/b1749465419d5761.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Istio Setup" duration="5">
        <h2 is-upgraded>Istio Installation</h2>
<p>Navigate to the directory <strong>3-DeployIstio</strong>, where there will be two scripts: Execute the script <strong>./1-deployIstio.sh</strong></p>
<p class="image-container"><img alt="DeployIstio" src="img/f50eda87c7a15560.png"></p>
<p>After the script runs, you will be presented with a URL to the <strong>Kiali web interface</strong> along with the username and password: <img alt="DeployIstio" src="img/619c8a43f2e21d24.png"></p>
<h2 is-upgraded>Define Istio Namespace</h2>
<p>Now that we have Istio and Kiali installed, we need to tell it which namespaces can use it.<br> We do this by adding the following label to any namespace where we plan to use Istio: <code>istio-enabled=enabled</code> In our case we are going to label the default namespace by running the script <strong>./2-labelNamespace.sh</strong></p>
<p class="image-container"><img alt="DeployIstio" src="img/acd82dbb2ce697af.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Traffic Routing" duration="15">
        <h2 is-upgraded>Traffic Routing Setup</h2>
<p>First let&#39;s deploy our application: Navigate to the folder <strong>4-TrafficRouting</strong> and execute the script <strong>./1-trafficroutingapplication.sh</strong> This will deploy our sample application and output the URL where the application can be accessed via a browser This is plain Kubernetes, nothing Istio related is deployed yet</p>
<p class="image-container"><img alt="TrafficRouting" src="img/6d337338b75a2663.png"></p>
<p>Once the deployment complete, navigate to the output URL to view the application:</p>
<p class="image-container"><img alt="SampleApp" src="img/c404709c01129a27.png"></p>
<h2 is-upgraded>Explore Sample App Fleet</h2>
<p>Clicking the different truck names on the left you will notice that the driver picture changes to either a placeholder photo or a real photo</p>
<p class="image-container"><img alt="SampleApp" src="img/40795dad67483654.png"></p>
<p>If you take a look at the running pods, you will see that we have two different pods running the staff service</p>
<p class="image-container"><img alt="SampleApp" src="img/a8c864652706813a.png"></p>
<p>Explore Service Flow in Dynatrace and you should see the below</p>
<p class="image-container"><img alt="SampleApp" src="img/fe0c911c6c58b0fb.png"></p>
<h2 is-upgraded>Explore Kiali</h2>
<p>In the Kiali UI, navigate to the Graph view and find the &#34;fleetman-staff-service&#34; and &#34;Show Details&#34;</p>
<p class="image-container"><img alt="SampleApp" src="img/ca32af948faf649.png"></p>
<p>Select Actions and <strong>Create Weighted Routing</strong> Set the <strong>&#34;Risky&#34;</strong> service to 10% Traffic Weight</p>
<p class="image-container"><img alt="SampleApp" src="img/9c8d4c6625926e0b.png"></p>
<p>You will now see that a <strong>Virtual Service</strong> and <strong>Destination Rule</strong> was create and we can view the YAML</p>
<p class="image-container"><img alt="SampleApp" src="img/a42d6baaa763127.png"></p>
<p>You will also see this in the console via kubectl</p>
<p class="image-container"><img alt="SampleApp" src="img/a0d4f05101820de.png"></p>
<p>In the UI we should now see the traffic weighting take affect and we should see the actual person image ~10% of the time and the placeholder image <strong>~90% of the time</strong> We can also see in the in the command line via cURL.  In the folder <strong>4-TrafficRouting</strong>, execute the command <code>./curlOutput.sh</code></p>
<p class="image-container"><img alt="SampleApp" src="img/402475013686c712.png"></p>
<p>Run the script <strong>./2-cleanUp.sh</strong> to remove the application and make sure you deleted the VirtualService and DestinationRules</p>


      </google-codelab-step>
    
      <google-codelab-step label="Ingress" duration="5">
        <p>First let&#39;s deploy our application, navigate to the folder <strong>5-Ingress</strong> and execute the script <code>./1-ingressapplication.sh</code></p>
<p>When the script completes you will end up with URL for the application</p>
<p>There is NO Istio specific configuration for this application (yet)</p>
<h2 is-upgraded>Blue Green versions of Fleet Manager</h2>
<p>You will notice if you refresh the page a few times, there are two different versions of the application:</p>
<p class="image-container"><img alt="SampleApp" src="img/407343bbc2d58cf9.png"></p>
<p>Since there is no Istio involved, traffic is currently weighted at 50<strong>⁄</strong>50 We can also see this via cURL, by running the script <code>./curlOutput.sh</code> in the folder <strong>5-Ingress</strong></p>
<p class="image-container"><img alt="SampleApp" src="img/3880679f37662146.png"></p>
<h2 is-upgraded>Explore Kiali</h2>
<p>Now let&#39;s create a traffic weighting so 90% of the traffic goes to the stable version and 10% of the traffic goes to the experimental version in Kiali</p>
<p class="image-container"><img alt="SampleApp" src="img/6b86b6d41bb9f161.png"></p>
<p class="image-container"><img alt="SampleApp" src="img/5dd5a2e64702824e.png"></p>
<p>However, when running the cURL script again, we still see a ~50⁄50 traffic weighting?</p>
<p class="image-container"><img alt="SampleApp" src="img/e7d263c04ac84a95.png"></p>
<p>Istio already provides us with an Ingress Service, we just need to configure it:</p>
<p class="image-container"><img alt="SampleApp" src="img/e2f68b46d736df41.png"></p>
<p>Run the script <code>./2-createIstioGateway.sh</code> in the folder <strong>5-Ingress</strong> which will create our Gateway, Virtual Service and Destination Rules. This will also output the URL for accessing the application through the Gateway</p>
<p class="image-container"><img alt="SampleApp" src="img/4241d4725cece604.png"></p>
<p>We should now see that we are getting about a 90⁄10 traffic weighting in the browser If we check Kiali we will also see the Gateway Service created, along with the Virtual Service and Destination Rules</p>
<p class="image-container"><img alt="SampleApp" src="img/a94059716c97c974.png"></p>
<p>We should also be able to see this in Dynatrace&#39;s Service Flow</p>
<p class="image-container"><img alt="SampleApp" src="img/82e0f245f0b13e0e.png"></p>
<p>Run the script ./cleanUp.sh to remove the Gateway Service, Virtual Service and Destination Rules The application will remain deployed</p>
<p class="image-container"><img alt="SampleApp" src="img/5c3fa0e6a03471d6.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Dark Releases" duration="15">
        <p>What are Dark Releases?</p>
<ul>
<li>Deploying a &#34;dormant&#34; version of an application/service</li>
<li>Control the exposed use base</li>
<li>Based on Feature Flags, IP Address, Header, URL, etc...</li>
</ul>
<h2 is-upgraded>Deploy Dark Releases</h2>
<p>Let&#39;s deploy our Dark Release configuration:</p>
<p>Navigate to the folder <strong>6-DarkReleases</strong> and execute the script <code>./1-createRoutingRules.sh</code></p>
<p>When you out the application in the output URL, the application should appear WITHOUT the red banner</p>
<p class="image-container"><img alt="Dark-Releases" src="img/81beaa70a8337145.png"></p>
<p>If we take a look at the yaml file with the routing rules we see how the traffic is routing:</p>
<p class="image-container"><img alt="Dark-Releases" src="img/5e5a80b723aaa4e.png"></p>
<p>If we access the application with the <strong>HTTP Header my-header:canary</strong>,we should see the experimental version, with the red banner displayed. We can add this header via a browser extension:</p>
<p class="image-container"><img alt="Dark-Releases" src="img/e18b6557b9becdb1.png"></p>
<p>We can determine what traffic is canary and which is not in Dynatrace with a Request Attribute:</p>
<p class="image-container"><img alt="Dark-Releases" src="img/7d959e7b8b020f8f.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Feedback" duration="3">
        <p>We hope you enjoyed this lab and found it useful. We would love your feedback! </p>
<google-codelab-survey survey-id="istio-1">
<h4>How was your overall experience with this lab?</h4>
<paper-radio-group>
<paper-radio-button>Excellent</paper-radio-button>
<paper-radio-button>Good</paper-radio-button>
<paper-radio-button>Average</paper-radio-button>
<paper-radio-button>Fair</paper-radio-button>
<paper-radio-button>Poor</paper-radio-button>
</paper-radio-group>
</google-codelab-survey>
<google-codelab-survey survey-id="istio-2">
<h4>What did you benefit most from this lab?</h4>
<paper-radio-group>
<paper-radio-button>Using OneAgent Operator to deploy in Kubernetes</paper-radio-button>
<paper-radio-button>Setting up Kubernetes integation</paper-radio-button>
<paper-radio-button>Enabling early access feature flags</paper-radio-button>
<paper-radio-button>Learning Kubernetes View in Dynatrace</paper-radio-button>
</paper-radio-group>
</google-codelab-survey>
<google-codelab-survey survey-id="istio-3">
<h4>How likely are you to recommend this lab to a friend or colleague?</h4>
<paper-radio-group>
<paper-radio-button>Very Likely</paper-radio-button>
<paper-radio-button>Moderately Likely</paper-radio-button>
<paper-radio-button>Neither Likely nor unlikely</paper-radio-button>
<paper-radio-button>Moderately Unlikely</paper-radio-button>
<paper-radio-button>Very Unlikely</paper-radio-button>
</paper-radio-group>
</google-codelab-survey>
<aside class="special"><p>💡 For other ideas and suggestions, please <a href="mailto:APAC-SE-Central@dynatrace.com?subject=Kubernetes Workshop - Ideas and Suggestions" target="_blank"><strong>reach out via email</strong></a>.</p>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="../../elements/codelab-elements/native-shim.js"></script>
  <script src="../../elements/codelab-elements/custom-elements.min.js"></script>
  <script src="../../elements/codelab-elements/prettify.js"></script>
  <script src="../../elements/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
